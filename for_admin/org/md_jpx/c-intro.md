# プログラムコードの解説

## プログラムを読むための基礎知識

### 構成の概略

AGCM のプログラム本体は, 階層化された構造を持っており, 複数のディレクトリに, それぞれ複数のファイルに分けられて管理されている. 一つのファイル(パッケージ)には, さらにいくつかのプログラムモジュール(サブルーチン,関数)が入っており, 場合によっては, 一つのモジュールに複数のエントリーが存在する.

例:

<span>**ディレクトリ**</span>**dynamics: **  
<span>**ファイル**</span>**dadmn.F: ** \* PACKAGE DADMN  
:  
<span>**ファイル**</span> **dshpe.F: ** \* PACKAGE DSPHE  
<span>**モジュール DSETNM: **</span> ̄ <span>**モジュール W2G**</span> SUBROUTINE W2G  
ENTRY G2W  
ENTRY SPSTUP  
<span>**モジュール DSETNM:**</span> SUBROUTINE DSETNM  

### ディレクトリ構成

現在, ディレクトリは以下の9個である.

  - TAB00005:0.0  
    admin

  - TAB00005:0.1  
    モデル全体の構成(座標・時刻・定数等)に関わるモジュール

  - TAB00005:1.0  
    dynamics

  - TAB00005:1.1  
    力学過程に関わるモジュール

  - TAB00005:2.0  
    physics

  - TAB00005:2.1  
    物理過程に関わるモジュール

  - TAB00005:3.0  
    io

  - TAB00005:3.1  
    データ入出力関係のモジュール

  - TAB00005:4.0  
    util

  - TAB00005:4.1  
    汎用演算ライブラリ類

  - TAB00005:5.0  
    sysdep

  - TAB00005:5.1  
    システム依存モジュール

  - TAB00005:6.0  
    include

  - TAB00005:6.1  
    <span>`#include`</span>によって取り込まれるヘッダ類

  - TAB00005:7.0  
    nonstd

  - TAB00005:7.1  
    非標準プラグイン・モジュール

  - TAB00005:8.0  
    special

  - TAB00005:8.1  
    テストモジュール

なお, メインルーチンを含むファイルは <span>`src/`</span> 直下に存在する.

これらの依存関係は, 以下のようになっている.

  - TAB00006:0.0  
    MAIN

  - TAB00006:0.1  
    \- admin

  - TAB00006:0.2

  - TAB00006:1.0

  - TAB00006:1.1  
    \- dynamics

  - TAB00006:1.2

  - TAB00006:2.0

  - TAB00006:2.1  
    \- physics

  - TAB00006:2.2

  - TAB00006:3.0

  - TAB00006:3.1

  - TAB00006:3.2  
    \- io

  - TAB00006:3.3

  - TAB00006:4.0

  - TAB00006:4.1

  - TAB00006:4.2

  - TAB00006:4.3  
    \- util

  - TAB00006:4.4

  - TAB00006:5.0

  - TAB00006:5.1

  - TAB00006:5.2

  - TAB00006:5.3

  - TAB00006:5.4  
    \- sysdep

すなわち, 同列に並ぶものはそれぞれ独立であり, 左に位置するものは右に位置するものを呼んで用いるが, 逆は許していない.

関係の深い複数のルーチンが1つのファイル(パッケージ)に入っている. 特に物理過程においては, 1つまたは少数のファイルの差し替えによって パラメタリゼーションの使い替えが可能となっている.

### プログラムにおける特記事項

1.  ENTRY 文を用いて複数エントリを持たせたモジュールがいくつか存在する. その主な目的は, データのローカルな保持である. 例えば, 上にあげたモジュール W2G の場合, PNM, DPNM といった変数が このモジュールのローカル変数として保持され, W2G, G2W, SPSTUP において共通に用いられる. W2G, G2W はいろいろなところで用いられるが, この構造をとったことにより, PNM, DPNM を引数として用いなけらばならない煩雑さを避けることができる. 通常このような場合には COMMON 変数を用いることが多い. ここでは, COMMON 変数は管理やデバッグにおいて不都合があるために できる限り避けており, その代わり, このようなカプセル化構造を用いている.

2.  COMMON は 2つだけ使用されている.
    
      - TAB00007:0.0  
        COMMON /COMCON/
    
      - TAB00007:0.1  
        標準物理定数(地球半径,気体定数など)
    
      - TAB00007:1.0  
        無名 COMMON
    
      - TAB00007:1.1  
        ワーク領域
    
    COMCON は, 標準的に用いられる物理定数を含んだものである. この COMMON 定義は <span>`include/zccom.F`</span> に入っており, 必要に応じて include して用いる. 値のセットは, サブルーチン PCONST (<span>`admin/apcon.F`</span>)を呼び出して行なう. 無名 COMMON ブロックは, 多くのモジュールからワーク領域として用いられる. 全体のメモリ消費を少なくするために用いている. 該当する COMMON文を全て削除しても, メモリ量に影響するだけで問題はない.

3.  include によるファイルの取り込みおよび条件つきコンパイルのために Cプリプロセッサ命令を用いている. そのため, ファイル名が<span>`.f`</span> でなく, <span>`.F`</span> となっている. 条件つきコンパイルとしては, <span>`#ifdef`</span> および <span>`#ifndef`</span> による選択を用いている. ファイルの取り込みは <span>`inlcude`</span> ディレクトリから行なっており, 以下のようなものである.
    
      - TAB00008:0.0  
        配列の大きさに関わるパラメータ文
    
      - TAB00008:0.1  
        zcdim.F
    
      - TAB00008:1.0
    
      - TAB00008:1.1  
        zpdim.F
    
      - TAB00008:2.0
    
      - TAB00008:2.1  
        zidim.F
    
      - TAB00008:3.0
    
      - TAB00008:3.1  
        zsdim.F
    
      - TAB00008:4.0
    
      - TAB00008:4.1  
        zhdim.F
    
      - TAB00008:5.0
    
      - TAB00008:5.1  
        zradim.F
    
      - TAB00008:6.0
    
      - TAB00008:6.1  
        zwdim.F
    
      - TAB00008:7.0  
        COMMON 定義(物理定数)
    
      - TAB00008:7.1  
        zccom.F
    
      - TAB00008:8.0  
        文関数定義 (飽和比湿)
    
      - TAB00008:8.1  
        zqsat.F

4.  FORTRAN 77 規格外の仕様として, NAMELIST による読み込みを使用しているが, 多くの処理系で問題無く使用可能であると思われる. NAMELIST の仕様については, 各処理系のマニュアルを参照のこと.

### プログラム書法

1.  各種説明に行末コメントを用いている. `!"` 以下行末までがコメントである \[1\].

2.  変数は全て宣言している. IMPLICIT NONE (例えばSun の場合 <span>`-u`</span> オプション)を 利用することが前提である.

3.  各エントリーの引数は, 継続行の欄を用いて機能の説明を加えている.
    
      - TAB00009:0.0  
        記号
    
      - TAB00009:0.1  
        意味
    
      - TAB00009:0.2  
        入力
    
      - TAB00009:0.3  
        出力
    
      - TAB00009:0.4  
        機能
    
      - TAB00009:1.0  
        O
    
      - TAB00009:1.1  
        output
    
      - TAB00009:1.2  
        ×
    
      - TAB00009:1.3  
        ○
    
      - TAB00009:1.4  
        値を生成
    
      - TAB00009:2.0  
        M
    
      - TAB00009:2.1  
        modify
    
      - TAB00009:2.2  
        ○
    
      - TAB00009:2.3  
        ○
    
      - TAB00009:2.4  
        入力値を加工して出力
    
      - TAB00009:3.0  
        I
    
      - TAB00009:3.1  
        input
    
      - TAB00009:3.2  
        ○
    
      - TAB00009:3.3  
        −
    
      - TAB00009:3.4  
        入力値(‘変数’)
    
      - TAB00009:4.0  
        C
    
      - TAB00009:4.1  
        constant
    
      - TAB00009:4.2  
        ○
    
      - TAB00009:4.3  
        −
    
      - TAB00009:4.4  
        入力値(‘定数’)
    
      - TAB00009:5.0  
        D
    
      - TAB00009:5.1  
        dimension
    
      - TAB00009:5.2  
        ○
    
      - TAB00009:5.3  
        −
    
      - TAB00009:5.4  
        整合配列の大きさを決める変数
    
      - TAB00009:6.0  
        W
    
      - TAB00009:6.1  
        work
    
      - TAB00009:6.2  
        ×
    
      - TAB00009:6.3  
        ×
    
      - TAB00009:6.4  
        作業領域
    
      - TAB00009:7.0  
        U
    
      - TAB00009:7.1  
        undefined
    
      - TAB00009:7.2  
        ×
    
      - TAB00009:7.3  
        ×
    
      - TAB00009:7.4  
        ダミー
    
    ここで, 入力, 出力の欄の意味は, 以下の通り. \[入力 \left\{
        \begin{array}{ll}   
          ○ &  中で値が参照される可能性がある \\
          × &  中に何が入っているかは問わない
        \end{array}  
         \right.\] \[出力 \left\{
        \begin{array}{ll}   
          ○ &  中で値が変更される可能性がある \\
          − &  値は変更されない \\
          × &  何がでてくるかは保証しない
        \end{array}  
         \right.\] ここで, 重要なのは M,O,I であり, C,D は I の一種である. C,D,I の使い分けはあまりきちんとしていない.

4.  各ファイルの内容は以下のようになっている.
    
    ` *" PACKAGE PSAVE データのセーブ/ロード(実メモリ版)  `  
    :̄ パッケージ名  
    `*"  [HIS] 93/11/10(numaguti) AGCM5.3`  
    : 変更ログ  
    `       SUBROUTINE PGSAVE    !" 内部データセーブ `  
    : モジュール宣言  
    `*   [PARAM]`  
    : 以下, パラメータ文が(includeされて)続く  
    ` *   [MODIFY]  `  
    : 以下, 入出力両用変数の宣言  
    ` *   [OUTPUT]  `  
    : 以下, 出力変数の宣言  
    ` *   [INPUT]  `  
    : 以下, 入力変数の宣言  
    ` *   [ENTRY OUTPUT]  `  
    : 以下, エントリーでの出力変数の宣言…  
    ` *   [INTERNAL WORK]  `  
    : 以下, 内部ワーク変数の宣言  
    `*   [INTERNAL SAVE]`  
    : 以下, 内部変数(RETURN後も保持すべきもの)の宣言  
    `*   [INTERNAL PARAM]`  
    : 以下, 内部パラメタ(NAMELIST等で読み込む)の宣言  
    `*   [ONCE]`  
    : 以下, 最初の呼びだし時に一回のみ行なう部分  

5.  文番号は, ブロック毎に千番台の番号を割り当て, なるべく構造的に当てている.

### 命名規則

1.  変数, エントリー名などの名称は6文字以下としている.

2.  変数名と型の対応
    
      - TAB00010:0.0  
        A–G,P-Z
    
      - TAB00010:0.1  
        浮動小数点数 (<span>`REAL*8`</span>)
    
      - TAB00010:1.0  
        H
    
      - TAB00010:1.1  
        文字列 (<span>`CHARACTER`</span>)
    
      - TAB00010:2.0  
        I–N
    
      - TAB00010:2.1  
        整数 (<span>`INTEGER`</span>)
    
      - TAB00010:3.0  
        O
    
      - TAB00010:3.1  
        論理型 (<span>`LOGICAL`</span>)
    
    ただし, NAMELIST によって読み込まれる変数においては, これを満たしていない場合がある.

3.  変数名等と内容の対応についての慣例
    
      - TAB00011:0.0  
        接頭子:
    
      - TAB00011:0.1  
        GA
    
      - TAB00011:0.2  
        格子点状態量(TERM01202)
    
      - TAB00011:1.0
    
      - TAB00011:1.1  
        GB
    
      - TAB00011:1.2  
        格子点状態量(TERM01203)
    
      - TAB00011:2.0
    
      - TAB00011:2.1  
        GD
    
      - TAB00011:2.2  
        格子点状態量(共通に用いる場合)
    
      - TAB00011:3.0
    
      - TAB00011:3.1  
        GT
    
      - TAB00011:3.2  
        格子点状態量の時間微分項
    
      - TAB00011:4.0
    
      - TAB00011:4.1  
        WD
    
      - TAB00011:4.2  
        状態量のスペクトル表現
    
      - TAB00011:5.0
    
      - TAB00011:5.1  
        WT
    
      - TAB00011:5.2  
        状態量の時間微分項のスペクトル表現
    
      - TAB00011:6.0
    
      - TAB00011:6.1  
        I
    
      - TAB00011:6.2  
        経度を示すインデックス
    
      - TAB00011:7.0
    
      - TAB00011:7.1  
        J
    
      - TAB00011:7.2  
        緯度を示すインデックス
    
      - TAB00011:8.0
    
      - TAB00011:8.1  
        K
    
      - TAB00011:8.2  
        鉛直レベルを示すインデックス
    
      - TAB00011:9.0
    
      - TAB00011:9.1  
        IJ
    
      - TAB00011:9.2  
        経緯度をひとまとめにしたインデックス
    
      - TAB00011:10.0
    
      - TAB00011:10.1  
        NM
    
      - TAB00011:10.2  
        スペクトルのインデックス
    
      - TAB00011:11.0
    
      - TAB00011:11.1  
        NM
    
      - TAB00011:11.2  
        NAMELIST 名
    
      - TAB00011:12.0
    
      - TAB00011:12.1  
        COM
    
      - TAB00011:12.2  
        COMMON 名
    
      - TAB00011:13.0  
        接尾子:
    
      - TAB00011:13.1  
        U
    
      - TAB00011:13.2  
        東西風
    
      - TAB00011:14.0
    
      - TAB00011:14.1  
        V
    
      - TAB00011:14.2  
        南北風
    
      - TAB00011:15.0
    
      - TAB00011:15.1  
        T
    
      - TAB00011:15.2  
        温度
    
      - TAB00011:16.0
    
      - TAB00011:16.1  
        PS
    
      - TAB00011:16.2  
        地表気圧
    
      - TAB00011:17.0
    
      - TAB00011:17.1  
        Q
    
      - TAB00011:17.2  
        比湿, 各種トレーサ−
    
      - TAB00011:18.0
    
      - TAB00011:18.1  
        QL
    
      - TAB00011:18.2  
        雲水量
    
      - TAB00011:19.0
    
      - TAB00011:19.1  
        FLX,FLUX
    
      - TAB00011:19.2  
        フラックス密度
    
      - TAB00011:20.0
    
      - TAB00011:20.1  
        MTX
    
      - TAB00011:20.2  
        陰解法で解くための行列
    
      - TAB00011:21.0
    
      - TAB00011:21.1  
        MAX
    
      - TAB00011:21.2  
        データの長さ
    
      - TAB00011:22.0
    
      - TAB00011:22.1  
        DIM
    
      - TAB00011:22.2  
        配列領域の大きさ

4.  ファイル名については, 1文字めはディレクトリの頭文字に統一している (ただし, <span>`include`</span> は <span>`z`</span>). また, <span>`-admn`</span>(administer)はその中の主モジュールを示す.

<!-- end list -->

1.  ここで, `!` だけでなく, 2文字を用いている理由は, 別の行末コメント形式を用いるシステム(HITAC VOS3など) のための置換を確実にするため, および, `!` だけだと Sun の CPP が誤動作するためである.
